{% extends 'base.html' %}
{% load static %}

{% block extra_css %} 
        <link rel="stylesheet" href="{% static 'css/style.css' %}"> 
    {% endblock %}

{% block title %}Write Prescription - Care Point Hospital{% endblock %}

{% block content %}
<div class="dashboard-layout">
    {% include 'includes/sidebar.html' %}
    
    <main class="main-content">
        <div class="page-header">
            <h1 class="page-title">Write Prescription</h1>
            <a href="{% url 'doctors:appointment_detail' appointment.pk %}" class="btn btn-secondary">← Back</a>
        </div>
        
        <div class="card mb-3">
            <div class="card-body">
                <div class="d-flex justify-between align-center">
                    <div>
                        <p><strong>Patient:</strong> {{ appointment.patient }}</p>
                        <p><strong>Visit Date:</strong> {{ appointment.scheduled_datetime|date:"M d, Y" }}</p>
                    </div>
                    <div>
                        {% if appointment.payment_status == 'paid' %}
                            {% with pay_info=appointment.payment_details %}
                            <span class="badge badge-{{ pay_info.css }}">{{ pay_info.label }}</span>
                            {% endwith %}
                        {% elif appointment.payment_status == 'unpaid' %}
                            <span class="badge badge-warning">Unpaid</span>
                            <a href="{% url 'doctors:mark_appointment_paid' appointment.pk %}" 
                               class="btn btn-sm btn-success ml-2" 
                               onclick="return confirm('Confirm that you have received Rs. {{ appointment.doctor.consultation_fee }} offline?');">
                               Mask as Paid
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <form method="post">
            {% csrf_token %}
            
            <div class="card mb-3">
                <div class="card-header">
                    <h4>Diagnosis & Notes</h4>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label>Diagnosis *</label>
                        {{ form.diagnosis }}
                    </div>
                    <div class="form-group">
                        <label>Additional Notes</label>
                        {{ form.notes }}
                    </div>
                </div>
            </div>
            
            <div class="card mb-3">
                <div class="card-header d-flex justify-between align-center">
                    <h4>Prescribed Medicines</h4>
                    <button type="button" id="add-medicine" class="btn btn-primary btn-sm">+ Add Medicine</button>
                </div>
                <div class="card-body" id="medicines-container">
                    {{ formset.management_form }}
                    {% for item_form in formset %}
                    <div class="medicine-row" style="padding: 1rem; background: var(--bg-primary); border-radius: var(--radius-md); margin-bottom: 1rem; position: relative;">
                        {% if forloop.counter0 > 0 %}
                        <button type="button" class="remove-medicine btn btn-danger btn-sm" style="position: absolute; top: 0.5rem; right: 0.5rem;">✕ Remove</button>
                        {% endif %}
                        <div class="grid grid-2">
                            <div class="form-group">
                                <label>Medicine Name</label>
                                {{ item_form.medicine_name }}
                            </div>
                            <div class="form-group">
                                <label>Dosage</label>
                                {{ item_form.dosage }}
                            </div>
                        </div>
                        <div class="grid grid-2">
                            <div class="form-group">
                                <label>Frequency</label>
                                {{ item_form.frequency }}
                            </div>
                            <div class="form-group">
                                <label>Duration</label>
                                {{ item_form.duration }}
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Instructions</label>
                            {{ item_form.instructions }}
                        </div>
                        <!-- Hidden fields for form management -->
                        <div style="display: none;">
                            {{ item_form.id }}
                            {{ item_form.DELETE }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary btn-lg">Save Prescription</button>
        </form>
    </main>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('medicines-container');
    const addBtn = document.getElementById('add-medicine');
    const totalForms = document.getElementById('id_items-TOTAL_FORMS');
    
    // Add new medicine row
    addBtn.addEventListener('click', function() {
        const formCount = parseInt(totalForms.value);
        const newRow = container.querySelector('.medicine-row').cloneNode(true);
        
        // Update form index in all input names/ids
        newRow.querySelectorAll('input, textarea, select').forEach(input => {
            const name = input.name.replace(/-\d+-/, `-${formCount}-`);
            const id = input.id.replace(/-\d+-/, `-${formCount}-`);
            input.name = name;
            input.id = id;
            input.value = '';
            
            // Uncheck DELETE checkbox for new forms
            if (input.name.includes('-DELETE')) {
                input.checked = false;
            }
        });
        
        // Add remove button if not present
        if (!newRow.querySelector('.remove-medicine')) {
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'remove-medicine btn btn-danger btn-sm';
            removeBtn.style.cssText = 'position: absolute; top: 0.5rem; right: 0.5rem;';
            removeBtn.textContent = '✕ Remove';
            newRow.appendChild(removeBtn);
        }
        
        container.appendChild(newRow);
        totalForms.value = formCount + 1;
    });
    
    // Remove medicine row
    container.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-medicine')) {
            const row = e.target.closest('.medicine-row');
            const deleteCheckbox = row.querySelector('input[name$="-DELETE"]');
            if (deleteCheckbox) {
                deleteCheckbox.checked = true;
                row.style.display = 'none';
            } else {
                row.remove();
                // Update total forms count
                totalForms.value = container.querySelectorAll('.medicine-row:not([style*="display: none"])').length;
            }
        }
    });
});
</script>
{% endblock %}
